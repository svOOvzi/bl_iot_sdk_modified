# BL602 Rust Firmware

This BL602 firmware executes Rust code by injecting the compiled Rust code into the `rust_app` library...

- [`rust-app`: BL602 Stub Library for Rust Application](../../components/3rdparty/rust-app)

Rust source code for the BL602 firmware is here...

- [`rust`: Rust source code](rust)

Build the BL602 firmware with this Rust build script...

- [`run.sh`: Rust build script](run.sh)

This script uses a Custom Rust Target `riscv32imacf-unknown-none-elf`...

- [`riscv32imacf-unknown-none-elf.json`: Rust Target for BL602](riscv32imacf-unknown-none-elf.json)

This Custom Rust Target is a minor tweak of the standard Rust target `riscv32imac-unknown-none-elf`...

1. We set `features` to `+m,+a,+c,+f` to generate RISC-V binaries with Single-Precision Hardware Floating-Point (`+f`)

1. We set `llvm-abiname` to `ilp32f` to support Single-Precision Hardware Floating-Point for the Application Binary Interface

We can't use the standard target `riscv32imac-unknown-none-elf` because...

1. BL602 IoT SDK was compiled with `gcc -march=rv32imfc -mabi=ilp32f`

   (Single-Precision Hardware Floating-Point)

1. Linker fails with error `can't link soft-float modules with single-float modules`

How did we figure out the tweaks for the Custom Rust Target?

By comparing the Rust Target Specs for `riscv32imac-unknown-none-elf` vs `riscv64gc-unknown-none-elf`...

1.  [`riscv32imac-unknown-none-elf.json`: 32-bit RISC-V with software floating point](customer_app/sdk_app_rust/riscv32imac-unknown-none-elf.json)

    Generated by...

    ```bash
    rustc +nightly -Z unstable-options --print target-spec-json --target riscv32imac-unknown-none-elf
    ```

1.  [`riscv64gc-unknown-none-elf.json`: 64-bit RISC-V with double-precision hardware floating point](customer_app/sdk_app_rust/riscv64gc-unknown-none-elf.json)

    Generated by...

    ```bash
    rustc +nightly -Z unstable-options --print target-spec-json --target riscv64gc-unknown-none-elf
    ```

Read the Twitter Thread...

https://twitter.com/MisterTechBlog/status/1383219945308184578
